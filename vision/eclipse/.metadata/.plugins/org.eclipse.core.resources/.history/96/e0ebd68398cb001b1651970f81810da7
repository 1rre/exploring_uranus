
#include <stdio.h>
#include <string.h>
#include <unistd.h>
#include <stdlib.h>

#include "sys/alt_irq.h"
#include "io.h"
#include "altera_avalon_pio_regs.h"
#include "altera_avalon_spi_regs.h"
#include "system.h"


int main() {
  printf("Hello from Nios II!\n");
  alt_u16 x1 = 611;
  alt_u16 y1 = 34+640;
  alt_u16 x2 = 233;
  alt_u16 y2 = 211+640;
  alt_u8 ball = 0;
  inline void esp_send(alt_u8, alt_u16);
loop:
  printf("Sending ball: %d, x1: %x\n", ball, x1);
  esp_send(ball, x1);
  printf("Sending ball: %d, y1: %x\n", ball, y1);
  esp_send(ball, y1);
  printf("Sending ball: %d, x2: %x\n", ball, x2);
  esp_send(ball, x2);
  printf("Sending ball: %d, y2: %x\n", ball, y2);
  esp_send(ball, y2);
  usleep(2500000);
  ball++;
  ball %= 5;
  goto loop;
  inline void esp_send(alt_u8 ball, alt_u16 pos) {
    IOWR_ALTERA_AVALON_PIO_DATA(ARDUINO_BALL_BASE, ball);
    IOWR_ALTERA_AVALON_PIO_DATA(ARDUINO_VAL_BASE, pos & 0b11111);
    IOWR_ALTERA_AVALON_PIO_DATA(ARDUINO_CTRL_BASE, 0b10);
    usleep(250);
    IOWR_ALTERA_AVALON_PIO_DATA(ARDUINO_CTRL_BASE, 0b00);
    IOWR_ALTERA_AVALON_PIO_DATA(ARDUINO_VAL_BASE, (pos>>5) & 0b11111);
    IOWR_ALTERA_AVALON_PIO_DATA(ARDUINO_CTRL_BASE, 0b11);
    usleep(250);
    IOWR_ALTERA_AVALON_PIO_DATA(ARDUINO_CTRL_BASE, 0b00);
   }
}
