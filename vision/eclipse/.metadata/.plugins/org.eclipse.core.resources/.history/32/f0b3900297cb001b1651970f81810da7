
#include <stdio.h>
#include <string.h>
#include <unistd.h>
#include <stdlib.h>

#include "sys/alt_irq.h"
#include "io.h"
#include "altera_avalon_pio_regs.h"
#include "altera_avalon_spi_regs.h"
#include "system.h"

static void __spi_callback(void*);
int* slp;
int main() {
  printf("Hello from Nios II!\n");
loop:
  IOWR_ALTERA_AVALON_SPI_TXDATA(ARDUINO_BASE, 'a');
  printf("Loop Init, data: %c\n", 'H');
  IOWR_ALTERA_AVALON_PIO_DATA(ARDUINO_CTRL_BASE, 0b10);
  IOWR_ALTERA_AVALON_PIO_DATA(ARDUINO_CTRL_BASE, 0b00);
  IOWR_ALTERA_AVALON_PIO_DATA(ARDUINO_INTERRUPT_BASE, 0);
  while (*slp) usleep(100);
  usleep(250000);
  it++;
  if (!*it) it = msg;
  goto loop;
}

static void __spi_callback(void* _msg) {
  *slp = 1;
  //char msg = *(char*)_msg;
  while (!(IORD_ALTERA_AVALON_SPI_STATUS(ARDUINO_BASE) & ALTERA_AVALON_SPI_STATUS_RRDY_MSK)) usleep(100);
  int recv = IORD_ALTERA_AVALON_SPI_RXDATA(ARDUINO_BASE);

  IOWR_ALTERA_AVALON_SPI_STATUS(ARDUINO_BASE, 0x0);

  printf("recv: %x\n", recv);
  *slp = 0;
}
