
#include <stdio.h>
#include <string.h>
#include <unistd.h>
#include <stdlib.h>

#include "alt_types.h"
#include "io.h"
#include "system.h"
#include "altera_avalon_pio_regs.h"

#define ALIGN_TOP_L 016000
#define ALIGN_BOT_R 017777

void send(alt_u16 pos, alt_u8 ball) {
  pos <<= 3;
  pos |= (ball & 7);
  IOWR_ALTERA_AVALON_PIO_DATA(ARDUINO_BASE, pos);
  IOWR_ALTERA_AVALON_PIO_DATA(ARDUINO_INTERRUPT_BASE, 1);
  IOWR_ALTERA_AVALON_PIO_DATA(ARDUINO_INTERRUPT_BASE, 0);
}

int main() {
  printf("Hello from Nios II!\n");
  int counter, ball;
loop: // Is this necessary - interrupt registered?
  send(ALIGN_TOP_L,0);
  usleep(100000);
  send(counter++,0);
  usleep(100000);
  send(ALIGN_BOT_R,0);
  usleep(100000);
  send(counter++,0);
  usleep(100000);
  counter %= 1024;
  printf("Loop, counter is %d\n", counter);
  goto loop;
}
